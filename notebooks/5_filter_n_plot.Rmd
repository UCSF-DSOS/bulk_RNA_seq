---
title: "Filter and plot expression" 
author: "Karla Lindquist"
output: html_notebook
---

#### *Objective 4. Filter out genes with low expression and plot*

Packages used in this notebook: `edgeR`, `RColorBrewer`. Make sure these packages are installed and loaded.

------------------------------------------------------------------------

The next step is to filter out genes with low intensity (this is a crude way of filtering - it's not a recommendation, just showing how this could be done). Say we want to select genes where at least 3 of the 9 samples have some expression (i.e. raw counts\>0, or CMP\>1). We will call this new object `dge_sub` (a subset of the `dge` object).

```{r}
dim(dge)
dge_sub <- dge[rowSums(cpm>1)>=3, ]
dim(dge_sub)
```

If this code seems mysterious, break it down piece by piece.

```{r}
head(cpm)
head(rowSums(cpm>1)) ## gets total number of samples with expression for each gene
head(rowSums(cpm>1)>=3) ## indicates if each of the totals above are >= 3
```

------------------------------------------------------------------------

##### **Discussion**

What are some ways to decide on the filtering criteria? How do you do it? What are the strengths and weaknesses of these options:

-   Intensity-based (e.g. decide a-priori: if genes are not expressed in x% of samples, remove).
-   Statistically-based (e.g. calculate coefficient of variation CV or adjusted p-values for each gene across samples, decide a-priori to remove genes outside of a certain range).
-   Biologically-based (e.g. look at genes of interest).

------------------------------------------------------------------------

##### Compare filtered to unfiltered data

Now compare the size of the original raw count data to the filtered data.

```{r}
100 * nrow(dge_sub) / nrow(dge)
```

So we're only going to be using \~52% of the data, but when we look at the distribution of the raw and unfiltered data, we see that this helps.

Now let's plot the raw and filtered data distributions (density) side-by-side. Why? We want to check two things: a) to see if the filtered data is normally distributed and b) to check that the samples have similar distributions. This doesn't tell us which genes have differential expression between the samples but it has implications for the statistical testing to determine this. More on this later.

First, let's assign different colors to each of the 9 samples so we can overlay them and be able to distinguish them from each other more easily. We can use the `RColorBrewer` package to assign the colors by sample type.

```{r}
?RColorBrewer

nsamples <- ncol(dge_sub) ## 9 samples
col <- brewer.pal(n = nsamples, name = "Paired") ## the paird option gives up to 12 distinct colors 
col
```

Now can plot the log2(CPM) distributions for both raw and filtered data. We created `log2_cpm` in Objective 3 but we'll create it here again and name it `log2cpm_raw` to distingush it from the filtered data, which we will call `log2cpm_sub`. We are just using that `cpm` function again.

```{r}
log2cpm_raw <- cpm(dge, log=TRUE) ## raw unfiltered expression (log2 CPM)
log2cpm_sub <- cpm(dge_sub, log=TRUE) ## filtered
```

The `density()` function from the `stats` package will give us the data to plot the raw and filtered data. We will start with just the first sample (column 1) so we can compare the means and median etc. for that sample.

```{r}
density(log2cpm_raw[,1])
density(log2cpm_sub[,1])
```

Now, we will set up a plot with 2 side-by-side density plots. We'll put the raw data on the left plot and the filtered data on the right. This is done with the `par()` function (see `?par` for general plot parameters).

We'll start by making the first plot of just the first sample, then we will combine the samples using a for loop and overlay these as lines on the same plot.

```{r}
par(mfrow=c(1,2))
plot(density(log2cpm_raw[,1]),
     col=col[1], 
     lwd=2, 
     ylim=c(0,0.21), 
     las=2, 
     main="", 
     xlab="")
title(main="A. Raw data", xlab="Log2(CPM)")
abline(v=0, lty=3)

for (i in 2:nsamples){
    den <- density(log2cpm_raw[,i])
    lines(den$x, den$y, col=col[i], lwd=2)
}
```

Next we can make the second plot of filtered data on the right like we did for the raw data. We'll put all of the code together for the final plot.

```{r}
par(mfrow=c(1,2))
plot(density(log2cpm_raw[,1]),
     col=col[1], 
     lwd=2, 
     ylim=c(0,0.21), 
     las=2, 
     main="", 
     xlab="")
title(main="A. Raw data", xlab="Log2(CPM)")
abline(v=0, lty=3)

for (i in 2:nsamples){
    den <- density(log2cpm_raw[,i])
    lines(den$x, den$y, col=col[i], lwd=2)
}

plot(density(log2cpm_sub[,1]), 
    col=col[1], 
    lwd=2, 
    ylim=c(0,0.21), 
    las=2, 
    main="", 
    xlab="")
title(main="B. Filtered data", xlab="Log2(CPM)")
abline(v=0, lty=3)

for (i in 2:nsamples){
    den <- density(log2cpm_sub[,i])
    lines(den$x, den$y, col=col[i], lwd=2)
}
```

**Question:** why is there that peak on the left side of the raw data? Recall what I said about the `cpm` function in the previous notebook about what happens to zero counts. s
